<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NHT Tipping</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body style="font-family: Arial; text-align: center; padding: 40px;">
  <h2>🪙 NEW HEAVEN TOKEN Tip</h2>
  <p>MetaMaskに接続して、NHTを送金しよう！</p>

  <button id="connectButton">🔌 MetaMask 接続</button>
  <div id="walletAddress" style="margin: 10px 0; font-weight: bold;"></div>

  <input type="text" id="recipient" placeholder="送り先アドレス" style="width: 300px; padding: 10px; margin-top: 20px;"><br>
  <input type="text" id="amount" placeholder="金額（NHT）" style="width: 300px; padding: 10px; margin-top: 10px;"><br>
  <input type="text" id="message" placeholder="メッセージ（任意）" style="width: 300px; padding: 10px; margin-top: 10px;"><br>

  <button id="tipButton" style="margin-top: 20px; padding: 10px 20px;">🚀 送金する</button>
  <p id="status" style="margin-top: 20px; color: green;"></p>

  <script>
    const contractAddress = "0x001b215d0d7bca5B5F1fefFF431c2799B8656e08"; // ←デプロイされたアドレス
    const abi = [
      "function tip(address recipient, uint256 amount, string memory message) external"
    ];

    let signer;

    document.getElementById("connectButton").onclick = async () => {
      if (window.ethereum) {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        const address = await signer.getAddress();
        document.getElementById("walletAddress").innerText = `接続中: ${address}`;
      } else {
        alert("MetaMaskが見つかりません。インストールしてください。");
      }
    };

    document.getElementById("tipButton").onclick = async () => {
      const recipient = document.getElementById("recipient").value;
      const amount = document.getElementById("amount").value;
      const message = document.getElementById("message").value;
      if (!signer || !recipient || !amount) {
        alert("必要な情報が足りません。全て入力してください。");
        return;
      }

      const contract = new ethers.Contract(contractAddress, abi, signer);
      const decimals = ethers.BigNumber.from("1000000000000000000"); // 18桁
      const amountWithDecimals = ethers.BigNumber.from(amount).mul(decimals);

      try {
        const tx = await contract.tip(recipient, amountWithDecimals, message);
        document.getElementById("status").innerText = "⏳ トランザクション送信中...";
        await tx.wait();
        document.getElementById("status").innerText = "✅ 送金完了！";
      } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "❌ 送金に失敗しました";
      }
    };
  </script>
</body>
</html>